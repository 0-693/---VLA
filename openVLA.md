
## OpenVLA 的 Action Head 设计详解

OpenVLA 的 Action Head 基于一种**语言模型 token 化的离散控制表示方法**，将机器人动作离散为 token，并直接作为语言模型的输出。这一机制继承自 RT-1 和 RT-2 的设计思路，并进一步进行量化优化以适配 LLaMA Tokenizer 的限制。

---

### 一、核心思想

OpenVLA 将机器人控制动作（共 7 维）表示为离散整数，并**作为语言模型的 token 输出**。其设计思想如下：

| 控制维度       | 含义                       |
|----------------|----------------------------|
| ΔPosition (3D) | 平移（x, y, z）            |
| ΔRotation (3D) | 欧拉角（roll, pitch, yaw） |
| Gripper (1D)   | 夹爪开合                   |

每个维度被**离散化为 256 个 bin**，最终将 7 个维度编码为 7 个整数 token，范围在 [0, 255] 之间。

---

### 二、Action Token 设计机制

#### 1. **动作离散化**

- 每个维度分别进行离散，使用 [1% ~ 99%] 分位数范围划分为 256 个 bin；
- 规避极值（outlier）影响，有效提升离散化精度；
- 每个 token 对应一个整数（如 `123`），最终组成动作字符串如：
  ```
  "128 91 241 5 101 127 36"
  ```

#### 2. **token 映射方法**

由于 LLaMA Tokenizer 默认仅支持引入 100 个新 token，OpenVLA 采用如下方式实现：

- **覆盖 tokenizer 中最少使用的 256 个 token**（即 vocabulary 的最后 256 项）；
- 将其映射为动作 token，称为 **Action De-Tokenizer**；
- 在训练中仅在动作预测部分对这些 token 进行监督。

---

### 三、动作头训练流程

#### 编码阶段：
- 将连续动作 → 7 个离散整数；
- 每个整数映射为 tokenizer 中的一个 token（如 <vocab_42000> → 动作 token）；
- 构造训练数据格式为：
  ```
  Q: what should the robot do to [task]?  
  A: 1 128 91 241 5 101 127
  ```

#### 解码阶段：
- 模型以标准语言生成方式输出 token 序列；
- 后处理模块将 token 解码回对应的离散 bin → 连续动作；
- 动作通过 robot controller 执行。

---

### 四、与其他模型对比

| 模型       | 动作头方式                 | Token数/step | 是否空间建模 | 是否自适应分布 |
|------------|----------------------------|--------------|----------------|------------------|
| RT-1       | 固定bin + MLP              | 7            | 否             | 否               |
| RT-2       | 固定bin + token            | 7            | 否             | 否               |
| SpatialVLA | Adaptive Grids + token     | **3**        | 是            | 是               |
| **OpenVLA**| **Tokenizer Mapping + token** | **7**        | 否            | 是（quantile）    |

---

### 五、设计优势总结

- **高效继承语言模型能力**：无需修改 LLaMA 架构，直接通过 token 微调；
- **兼容开源生态**：支持 HuggingFace 加载、LoRA 微调、量化部署；
- **离散化稳健性强**：采用分位数离散，避免异常值影响；
- **端到端训练简洁**：语言模型直接预测动作，结构简洁，推理稳定；
- **支持多机器人泛化**：基于 OpenX 多机器人数据训练，支持跨平台控制。

